<!DOCTYPE html>
<html>
  <head>
    <title>my example</title>
    <!-- pdfmake files: -->
    <script src="https://cdn.jsdelivr.net/npm/pdfmake@latest/build/pdfmake.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfmake@latest/build/vfs_fonts.min.js"></script>
    <!-- html-to-pdfmake file: -->
    <script src="https://cdn.jsdelivr.net/npm/html-to-pdfmake/browser.js"></script>
    <!-- PDF-lib for concat pdfs -->
    <script src="https://unpkg.com/pdf-lib@1.4.0"></script>
    <script src="https://unpkg.com/downloadjs@1.4.7"></script>
  </head>
  <body>
    <h1>
      <a href="https://github.com/Aymkdn/html-to-pdfmake">
        html-to-pdfmake
      </a>
      with
      <a href="https://github.com/Aymkdn/html-to-pdfmake">
        pdf-lib
      </a>
      concat example
    </h1>
    <p>Also threw in a pagebreak example.</p>

    <button type="button" onclick="downloadPdf();">Download</button>
    <iframe id="pdf" style="width: 100%; height: 400px;"></iframe>

    <script>
      const { PDFDocument } = PDFLib;

      let outPdfData = null;

      const val1 = htmlToPdfmake(`
     <div>
        <h1>ALL HAIL KEVIN BACON!</h1>
        <p>
          This is a sentence with a <strong>bold word</strong>, <em>one in italic</em>,
          and <u>one with underline</u>. And finally <a href="https://www.somewhere.com">a link</a>.
        </p>
        <table>
          <tr>
            <th style="width:150px">Header 1</th>
          </tr>
          <tr>
            <td style="text-align:center" height="50">Cell A1</td>
          </tr>
        </table>
        <span class="green">Text in green using the styles from PDFMake</small>
      </div>`);
      const val2 = htmlToPdfmake(`
     <div>
        <h1>KITTENS ARE HUNGRY</h1>
        <p>
          There will be a page break after this paragraph.
          This is a sentence with a <strong>bold word</strong>, <em>one in italic</em>,
          and <u>one with underline</u>. And finally <a href="https://www.somewhere.com">a link</a>.
        </p>
        <table class="pdf-pagebreak-before">
          <tr>
            <th style="width:150px">Header 1</th>
          </tr>
          <tr>
            <td style="text-align:center" height="50">Cell A1</td>
          </tr>
        </table>
        <span class="green">Text in green using the styles from PDFMake</small>
      </div>`);

      const dd1 = {
        content: [val1],
        pageBreakBefore: function (currentNode) {
          // we add a page break before TABLE with the classname "pdf-pagebreak-before"
          return (
            currentNode.table &&
            currentNode.style &&
            currentNode.style.indexOf("pdf-pagebreak-before") > -1
          );
        }
      };
      const dd2 = {
        content: [val2],
        pageBreakBefore: function (currentNode) {
          // we add a page break before TABLE with the classname "pdf-pagebreak-before"
          return (
            currentNode.table &&
            currentNode.style &&
            currentNode.style.indexOf("pdf-pagebreak-before") > -1
          );
        }
      };
      let inPdfData1 = null;
      let inPdfData2 = null;

      pdfMake.createPdf(dd1).getBuffer(function (outDoc1) {
        inPdfData1 = outDoc1;
        pdfMake.createPdf(dd2).getBuffer(function (outDoc2) {
          inPdfData2 = outDoc2;
          concatPdfs2();
        });
      });

      const concatPdfs2 = async function () {
        const mergedPdf = await PDFDocument.create();
        const pdfA = await PDFDocument.load(inPdfData1);
        const pdfB = await PDFDocument.load(inPdfData2);

        const copiedPagesA = await mergedPdf.copyPages(
          pdfA,
          pdfA.getPageIndices()
        );
        copiedPagesA.forEach((page) => mergedPdf.addPage(page));

        const copiedPagesB = await mergedPdf.copyPages(
          pdfB,
          pdfB.getPageIndices()
        );
        copiedPagesB.forEach((page) => mergedPdf.addPage(page));

        outPdfData = await mergedPdf.save();
        const pdfDataUri = await mergedPdf.saveAsBase64({ dataUri: true });
        document.getElementById("pdf").src = pdfDataUri;
      };

      const downloadPdf = function () {
        // Trigger the browser to download the PDF document
        download(
          outPdfData,
          "pdf-lib_page_copying_example.pdf",
          "application/pdf"
        );
      };
    </script>
  </body>
</html>
